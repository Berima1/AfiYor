<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfiYor - Your African AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .logo .tagline {
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .powered-by {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }

        /* User Account Section */
        .user-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .user-info {
            display: block;
        }

        .user-info.hidden {
            display: none;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .register-form {
            display: none;
        }

        .register-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-details h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .user-details p {
            color: #7f8c8d;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 11px;
            color: #7f8c8d;
        }

        .ubuntu-section {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .ubuntu-section h4 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ubuntu-quote {
            font-style: italic;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .chat-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            max-height: 400px;
        }

        .history-list {
            display: none;
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            max-height: 400px;
        }

        .history-list.active {
            display: block;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: background 0.3s;
        }

        .history-item:hover {
            background: #e9ecef;
        }

        .history-query {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .history-meta {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
        }

        .industry-tag {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .message.user .message-avatar {
            background: #3498db;
            color: white;
        }

        .message.bot .message-avatar {
            background: #27ae60;
            color: white;
        }

        .message-content {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.5;
            position: relative;
        }

        .message.user .message-content {
            background: #3498db;
            color: white;
            border-radius: 20px 20px 5px 20px;
        }

        .message.bot .message-content {
            background: #f8f9fa;
            color: #333;
            border-radius: 20px 20px 20px 5px;
            border-left: 4px solid #27ae60;
        }

        .message-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 15px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .message-meta {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .personalization-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        .chat-input {
            padding: 25px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            gap: 15px;
        }

        .chat-input input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ecf0f1;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: #3498db;
        }

        .chat-input button {
            padding: 15px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .chat-input button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .chat-input button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            color: #7f8c8d;
            font-style: italic;
        }

        .typing-dots {
            display: inline-flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #3498db;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .alert {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }
            
            .sidebar {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>🌍 AfiYor</h1>
                <div class="tagline">Your African AI Assistant</div>
                <div class="powered-by">Powered by Ubuntu AI v3.0</div>
            </div>

            <!-- User Account Section -->
            <div class="user-section">
                <!-- Logged In User Info -->
                <div id="userInfo" class="user-info hidden">
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-details">
                            <h3 id="userName">User Name</h3>
                            <p id="userLocation">Ghana • Fintech</p>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number" id="totalQueries">0</div>
                            <div class="stat-label">Queries</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="memberDays">1</div>
                            <div class="stat-label">Days</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="login-form">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Welcome Back!</h4>
                    <div id="loginAlert"></div>
                    <form onsubmit="login(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <button type="submit" class="btn">Login</button>
                    </form>
                    <p style="text-align: center; margin-top: 10px; font-size: 14px;">
                        <a href="#" onclick="showRegister()" style="color: #3498db;">Create new account</a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="register-form">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Join AfiYor!</h4>
                    <div id="registerAlert"></div>
                    <form onsubmit="register(event)">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="registerName" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>🌍 Country</label>
                            <select id="registerCountry" required>
                                <option value="ghana">🇬🇭 Ghana</option>
                                <option value="nigeria">🇳🇬 Nigeria</option>
                                <option value="kenya">🇰🇪 Kenya</option>
                                <option value="south_africa">🇿🇦 South Africa</option>
                                <option value="egypt">🇪🇬 Egypt</option>
                                <option value="ethiopia">🇪🇹 Ethiopia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Industry</label>
                            <select id="registerIndustry" required>
                                <option value="fintech">Fintech & Mobile Money</option>
                                <option value="agriculture">Agriculture & Agribusiness</option>
                                <option value="technology">Technology & Software</option>
                                <option value="retail">Retail & Commerce</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="services">Professional Services</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="logistics">Logistics & Transport</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Business Stage</label>
                            <select id="registerStage" required>
                                <option value="idea">Idea Stage</option>
                                <option value="startup">Early Startup</option>
                                <option value="growth">Growth Stage</option>
                                <option value="established">Established Business</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Create Account</button>
                    </form>
                    <p style="text-align: center; margin-top: 10px; font-size: 14px;">
                        <a href="#" onclick="showLogin()" style="color: #3498db;">Already have account?</a>
                    </p>
                </div>
            </div>

            <div class="ubuntu-section">
                <h4>🤝 Ubuntu Philosophy</h4>
                <div class="ubuntu-quote">"I am because we are"</div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container">
            <div class="chat-header">
                <h2>🌍 Chat with AfiYor</h2>
                <p>Your intelligent assistant for African business, culture, and Ubuntu philosophy</p>
                
                <div class="chat-tabs">
                    <button class="tab active" onclick="switchTab('chat')">💬 Chat</button>
                    <button class="tab" onclick="switchTab('history')" id="historyTab">📚 History</button>
                </div>
            </div>

            <div class="chat-content">
                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will appear here -->
                </div>

                <!-- History List -->
                <div class="history-list" id="historyList">
                    <p style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                        Login to view your conversation history
                    </p>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span>AfiYor is thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Ask about African business, Ubuntu philosophy, or startup advice..."
                    maxlength="500"
                >
                <button onclick="sendMessage()" id="sendButton">Send 🚀</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://afribot-backend-h9iv.onrender.com';
        let currentUser = null;
        let currentTab = 'chat';
        let conversationHistory = [];

        // Initialize app
        window.addEventListener('load', function() {
            checkExistingUser();
            showWelcomeMessage();
        });

        // User Management
        function checkExistingUser() {
            const userId = localStorage.getItem('afiyor_user_id');
            const userName = localStorage.getItem('afiyor_user_name');
            
            if (userId && userName) {
                currentUser = {
                    id: userId,
                    name: userName,
                    country: localStorage.getItem('afiyor_user_country') || 'ghana',
                    industry: localStorage.getItem('afiyor_user_industry') || 'general'
                };
                showUserInfo();
                loadConversationHistory();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.add('active');
        }

        function showUserInfo() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById('userInfo').classList.remove('hidden');
            
            // Update user info display
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userLocation').textContent = 
                `${currentUser.country.charAt(0).toUpperCase() + currentUser.country.slice(1)} • ${currentUser.industry}`;
        }

        async function login(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const alertDiv = document.getElementById('loginAlert');
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store user info
                    localStorage.setItem('afiyor_user_id', data.user_id);
                    localStorage.setItem('afiyor_user_name', data.name);
                    
                    currentUser = { id: data.user_id, name: data.name };
                    
                    alertDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    
                    setTimeout(() => {
                        showUserInfo();
                        loadConversationHistory();
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert alert-error">Connection error. Please try again.</div>`;
            }
        }

        async function register(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('registerName').value,
                email: document.getElementById('registerEmail').value,
                country: document.getElementById('registerCountry').value,
                industry: document.getElementById('registerIndustry').value,
                business_stage: document.getElementById('registerStage').value
            };
            
            const alertDiv = document.getElementById('registerAlert');
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store user info
                    localStorage.setItem('afiyor_user_id', data.user_id);
                    localStorage.setItem('afiyor_user_name', formData.name);
                    localStorage.setItem('afiyor_user_country', formData.country);
                    localStorage.setItem('afiyor_user_industry', formData.industry);
                    
                    currentUser = {
                        id: data.user_id,
                        name: formData.name,
                        country: formData.country,
                        industry: formData.industry
                    };
                    
                    alertDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    
                    setTimeout(() => {
                        showUserInfo();
                    }, 1000);
                } else {
                    alertDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert alert-error">Registration failed. Please try again.</div>`;
            }
        }

        function logout() {
            localStorage.removeItem('afiyor_user_id');
            localStorage.removeItem('afiyor_user_name');
            localStorage.removeItem('afiyor_user_country');
            localStorage.removeItem('afiyor_user_industry');
            
            currentUser = null;
            conversationHistory = [];
            
            // Clear chat
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('historyList').innerHTML = '<p style="text-align: center; color: #7f8c8d; margin-top: 50px;">Login to view your conversation history</p>';
            
            showLogin();
            showWelcomeMessage();
        }

        // Tab Management
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab appearance
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'chat') {
                document.getElementById('chatMessages').style.display = 'block';
                document.getElementById('historyList').classList.remove('active');
            } else if (tab === 'history') {
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('historyList').classList.add('active');
                loadConversationHistory();
            }
        }

        // Chat Functions
        function addMessage(content, isUser = false, metadata = {}) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = isUser ? (currentUser ? currentUser.name.charAt(0).toUpperCase() : 'U') : '🌍';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content;
            
            // Add message actions for bot messages
            if (!isUser && currentUser) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="action-btn" onclick="shareMessage('${metadata.conversation_id}')" title="Share">🔗</button>
                `;
                contentDiv.appendChild(actionsDiv);
            }
            
            // Add metadata
            if (metadata.confidence || metadata.personalized) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                
                let metaContent = '';
                if (metadata.confidence) {
                    metaContent += `Confidence: ${Math.round(metadata.confidence * 100)}%`;
                }
                if (metadata.personalized) {
                    metaContent += ` <span class="personalization-badge">Personalized</span>`;
                }
                metaContent += ` | Ubuntu AI v3.0`;
                
                metaDiv.innerHTML = metaContent;
                contentDiv.appendChild(metaDiv);
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            // Show typing indicator
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('sendButton').disabled = true;
            
            try {
                const requestData = {
                    message: message,
                    country: currentUser ? currentUser.country : 'ghana',
                    user_id: currentUser ? currentUser.id : 'anonymous',
                    session_id: 'session_' + Date.now()
                };
                
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                // Hide typing indicator
                document.getElementById('typingIndicator').style.display = 'none';
                document.getElementById('sendButton').disabled = false;
                
                if (data.response) {
                    addMessage(data.response, false, {
                        confidence: data.confidence,
                        personalized: data.personalized,
                        conversation_id: data.conversation_id
                    });
                    
                    // Update history if logged in
                    if (currentUser && currentTab === 'chat') {
                        loadConversationHistory();
                    }
                } else {
                    throw new Error('No response received');
                }
                
            } catch (error) {
                // Hide typing indicator
                document.getElementById('typingIndicator').style.display = 'none';
                document.getElementById('sendButton').disabled = false;
                
                // Fallback response
                addMessage(
                    `Ubuntu teaches us resilience! I'm having connection issues, but I can still help with African business advice. ${currentUser ? `Hi ${currentUser.name}! ` : ''}Try asking about startup opportunities in ${currentUser ? currentUser.country : 'Ghana'} or Ubuntu philosophy for entrepreneurs.`, 
                    false,
                    { confidence: 0.6 }
                );
                
                console.error('API Error:', error);
            }
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Conversation History
        async function loadConversationHistory() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/history/${currentUser.id}`);
                const data = await response.json();
                
                if (response.ok && data.conversations) {
                    conversationHistory = data.conversations;
                    displayHistory();
                    
                    // Update stats
                    document.getElementById('totalQueries').textContent = data.conversations.length;
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        function displayHistory() {
            const historyContainer = document.getElementById('historyList');
            
            if (conversationHistory.length === 0) {
                historyContainer.innerHTML = `
                    <p style="text-align: center; color: #7f8c8d; margin-top: 50px;">
                        No conversations yet. Start chatting to build your history!
                    </p>
                `;
                return;
            }
            
            let historyHTML = '';
            conversationHistory.forEach(conv => {
                const date = new Date(conv.created_at * 1000).toLocaleDateString();
                const preview = conv.query.length > 60 ? conv.query.substring(0, 60) + '...' : conv.query;
                
                historyHTML += `
                    <div class="history-item" onclick="showHistoryItem('${conv.id}')">
                        <div class="history-query">${preview}</div>
                        <div class="history-meta">
                            <span>${date} • ${conv.country}</span>
                            <span>
                                ${conv.industry_relevant ? '<span class="industry-tag">Industry</span>' : ''}
                                ${Math.round(conv.confidence * 100)}%
                            </span>
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }

        function showHistoryItem(conversationId) {
            const conversation = conversationHistory.find(c => c.id === conversationId);
            if (!conversation) return;
            
            // Switch to chat tab and show the conversation
            switchTab('chat');
            document.querySelector('.tab[onclick="switchTab(\'chat\')"]').classList.add('active');
            document.querySelector('.tab[onclick="switchTab(\'history\')"]').classList.remove('active');
            
            // Clear current chat and add the historical conversation
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Add the historical conversation
            addMessage(conversation.query, true);
            addMessage(conversation.response, false, {
                confidence: conversation.confidence,
                personalized: true
            });
            
            // Add a note that this is from history
            addMessage(
                `📚 <em>This conversation is from your history (${new Date(conversation.created_at * 1000).toLocaleDateString()}). Continue chatting to add new messages!</em>`,
                false,
                { confidence: 1.0 }
            );
        }

        // Sharing Functions
        async function shareMessage(conversationId) {
            if (!conversationId || !currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/share`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        user_id: currentUser.id,
                        title: 'AfiYor Business Advice'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const shareUrl = `${window.location.origin}/shared/${data.share_id}`;
                    
                    // Try to use native sharing if available
                    if (navigator.share) {
                        navigator.share({
                            title: 'AfiYor Business Advice',
                            text: 'Check out this business advice from AfiYor!',
                            url: shareUrl
                        });
                    } else {
                        // Fallback to clipboard
                        navigator.clipboard.writeText(shareUrl).then(() => {
                            alert('Share link copied to clipboard!');
                        }).catch(() => {
                            prompt('Copy this share link:', shareUrl);
                        });
                    }
                } else {
                    alert('Failed to create share link');
                }
            } catch (error) {
                console.error('Sharing failed:', error);
                alert('Sharing is not available right now');
            }
        }

        // Welcome message
        function showWelcomeMessage() {
            setTimeout(() => {
                if (currentUser) {
                    addMessage(
                        `🌍 <strong>Akwaaba ${currentUser.name}!</strong><br><br>
                        Welcome back to AfiYor! I remember you're in the ${currentUser.industry} industry in ${currentUser.country}. I'm ready to provide personalized advice for your business journey.<br><br>
                        <strong>Since you're in ${currentUser.industry}, try asking:</strong><br>
                        • Industry-specific challenges and opportunities<br>
                        • Market trends in ${currentUser.country}<br>
                        • How Ubuntu philosophy applies to ${currentUser.industry}<br>
                        • Business expansion strategies<br><br>
                        <em>Your conversations are saved in your history for reference. Ubuntu: "I am because we are" 🤝</em>`,
                        false,
                        { confidence: 1.0, personalized: true }
                    );
                } else {
                    addMessage(
                        `🌍 <strong>Akwaaba! Welcome to AfiYor!</strong><br><br>
                        I'm your African AI assistant powered by Ubuntu philosophy. I provide business advice with deep African cultural understanding.<br><br>
                        <strong>Create an account to get:</strong><br>
                        • Personalized advice for your industry<br>
                        • Conversation history and tracking<br>
                        • Shareable business insights<br>
                        • Cultural guidance for your country<br><br>
                        <strong>Or start chatting now about:</strong><br>
                        • Starting a business in Africa<br>
                        • Ubuntu philosophy for entrepreneurs<br>
                        • Mobile money and fintech opportunities<br>
                        • Cultural business practices<br><br>
                        <em>Remember: "I am because we are" - Your success strengthens our entire community! 🤝</em>`,
                        false,
                        { confidence: 1.0 }
                    );
                }
            }, 1000);
        }

        // Utility Functions
        function getIndustryEmoji(industry) {
            const emojis = {
                'fintech': '💳',
                'agriculture': '🌾', 
                'technology': '💻',
                'retail': '🛍️',
                'manufacturing': '🏭',
                'services': '🤝',
                'healthcare': '🏥',
                'education': '🎓',
                'logistics': '🚛'
            };
            return emojis[industry] || '💼';
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Today';
            if (diffDays === 2) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        // Auto-save user preferences
        function saveUserPreferences() {
            if (currentUser) {
                localStorage.setItem('afiyor_user_preferences', JSON.stringify({
                    theme: 'default',
                    notifications: true,
                    lastActive: Date.now()
                }));
            }
        }

        // Periodic functions
        setInterval(() => {
            if (currentUser) {
                saveUserPreferences();
            }
        }, 30000); // Save preferences every 30 seconds

        // Example queries for different industries
        const industryExamples = {
            'fintech': [
                "How do I integrate mobile money in Ghana?",
                "What are the regulations for fintech in Nigeria?", 
                "How can Ubuntu philosophy guide fintech innovation?"
            ],
            'agriculture': [
                "How do I connect smallholder farmers to markets?",
                "What are the best crops for climate resilience in Ghana?",
                "How can technology improve agriculture in Africa?"
            ],
            'technology': [
                "How do I build a tech team in Accra?",
                "What are the funding opportunities for African startups?",
                "How can I scale my app across West Africa?"
            ]
        };

        // Show industry-specific suggestions
        function showIndustrySuggestions() {
            if (!currentUser || !currentUser.industry) return;
            
            const suggestions = industryExamples[currentUser.industry];
            if (!suggestions) return;
            
            setTimeout(() => {
                const suggestionText = `💡 <strong>Popular ${currentUser.industry} questions:</strong><br><br>` +
                    suggestions.map(q => `• "${q}"`).join('<br>') +
                    '<br><br><em>Click on any suggestion above to try it!</em>';
                
                addMessage(suggestionText, false, { confidence: 1.0 });
            }, 5000);
        }

        // Initialize industry suggestions after welcome
        setTimeout(showIndustrySuggestions, 8000);
    </script>
</body>
    </html>
